#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ Deploy Fix: Empresa Fletera 999 Default
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e  # Exit on error

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ DEPLOYMENT: Empresa Fletera 999 Default Fix"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 1: Pull del cรณdigo
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ฅ PASO 1: Actualizando cรณdigo desde GitHub..."
cd /var/www/track
git pull origin main

echo "โ Cรณdigo actualizado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 2: Verificar SQL file
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASO 2: Verificando archivo SQL..."
if [ -f "fix-empresa-fletera-999.sql" ]; then
    echo "โ fix-empresa-fletera-999.sql encontrado"
    echo ""
    echo "๐ IMPORTANTE: Ejecutar este SQL en Supabase SQL Editor:"
    echo "   https://supabase.com/dashboard/project/lgniuhelyyizoursmsmi/sql"
    echo ""
    echo "   Copiar contenido de: fix-empresa-fletera-999.sql"
    echo ""
    read -p "ยฟYa ejecutaste el SQL en Supabase? (s/n): " sql_executed
    
    if [ "$sql_executed" != "s" ]; then
        echo ""
        echo "โ๏ธ  DEBES ejecutar el SQL primero para crear empresa 999"
        echo "   Abrir: https://supabase.com/dashboard/project/lgniuhelyyizoursmsmi/sql"
        echo "   Copiar y pegar contenido de fix-empresa-fletera-999.sql"
        echo "   Ejecutar (Run)"
        echo ""
        read -p "Presiona ENTER cuando hayas ejecutado el SQL..."
    fi
else
    echo "โ fix-empresa-fletera-999.sql NO encontrado"
    exit 1
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 3: Build
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐จ PASO 3: Building Next.js..."
rm -rf .next
pnpm build

if [ $? -eq 0 ]; then
    echo "โ Build completado exitosamente"
else
    echo "โ Build fallรณ"
    exit 1
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 4: Restart PM2
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โป๏ธ  PASO 4: Reiniciando PM2..."
pm2 restart track

if [ $? -eq 0 ]; then
    echo "โ PM2 reiniciado exitosamente"
else
    echo "โ PM2 restart fallรณ"
    exit 1
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 5: Verificar logs
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASO 5: Verificando logs (รบltimas 50 lรญneas)..."
sleep 3  # Esperar 3s para que inicie
pm2 logs track --lines 50 --nostream

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 6: Test endpoint
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐งช PASO 6: Testing endpoint..."
echo ""
echo "Ejecutar manualmente desde SGM o Postman:"
echo ""
echo "curl -X POST http://192.168.7.13:3002/api/import/moviles \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -H 'x-api-key: YOUR_API_KEY' \\"
echo "  -d '{"
echo '    "IdentificadorId": 9991,'
echo '    "EscenarioId": 1000,'
echo '    "Accion": "Publicar"'
echo "  }'"
echo ""
echo "Resultado esperado: 200 OK (no mรกs error 23502)"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMEN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ DEPLOYMENT COMPLETADO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "Cambios aplicados:"
echo "  โ Cรณdigo actualizado"
echo "  โ Build completado"
echo "  โ PM2 reiniciado"
echo ""
echo "Prรณximo paso:"
echo "  ๐งช Enviar mรณvil de prueba sin EFleteraId desde SGM"
echo "  ๐ Verificar en logs que aparece: empresa_fletera_id: 999"
echo "  ๐ Verificar en Supabase que mรณvil se creรณ exitosamente"
echo ""
echo "Monitoreo continuo:"
echo "  pm2 logs track --lines 100 | grep empresa_fletera_id"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
